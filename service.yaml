apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: postgres-prod
  annotations:
    run.googleapis.com/launch-stage: GA
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/cloudsql-instances: ${PROJECT_ID}:${REGION}:${CLOUDSQL_INSTANCE}
        run.googleapis.com/execution-environment: gen2
        run.googleapis.com/container-dependencies: '{"grpc-server":["envoy"]}'
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "10"
    spec:
      serviceAccountName: ${SERVICE_ACCOUNT}
      containerConcurrency: 80
      timeoutSeconds: 300
      containers:
        # Envoy sidecar - ingress container (receives traffic on port 8080)
        - name: envoy
          image: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/postgres-prod-envoy:${TAG}
          ports:
            - name: http1
              containerPort: 8080
          resources:
            limits:
              cpu: "500m"
              memory: "256Mi"
          startupProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 2
            failureThreshold: 10

        # gRPC server - main application (internal, port 9090)
        - name: grpc-server
          image: ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/postgres-prod:${TAG}
          env:
            - name: PORT
              value: "9090"
            - name: GCP_PROJECT_ID
              value: ${PROJECT_ID}
            - name: GCP_REGION
              value: ${REGION}
            - name: CLOUDSQL_INSTANCE_NAME
              value: ${CLOUDSQL_INSTANCE}
            - name: DB_NAME
              value: ${DB_NAME}
            - name: DB_USER
              value: ${DB_USER}
          resources:
            limits:
              cpu: "1000m"
              memory: "512Mi"
          startupProbe:
            grpc:
              port: 9090
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 10
