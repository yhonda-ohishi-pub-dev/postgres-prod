apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: postgres-prod
  annotations:
    run.googleapis.com/launch-stage: GA
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/cloudsql-instances: cloudsql-sv:asia-northeast1:postgres-prod
        run.googleapis.com/execution-environment: gen2
        run.googleapis.com/container-dependencies: '{"grpc-server":["envoy"]}'
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "10"
    spec:
      serviceAccountName: 747065218280-compute@developer.gserviceaccount.com
      containerConcurrency: 80
      timeoutSeconds: 300
      containers:
        # Envoy sidecar - ingress container (receives traffic on port 8080)
        - name: envoy
          image: asia-northeast1-docker.pkg.dev/cloudsql-sv/postgres-prod/postgres-prod-envoy@sha256:191095351e0dd0846a4b97ee31e98b9883dd64c4435524d1a13bc751ed79c8d3
          ports:
            - name: http1
              containerPort: 8080
          resources:
            limits:
              cpu: "500m"
              memory: "256Mi"
          startupProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 2
            failureThreshold: 10

        # gRPC server - main application (internal, port 9090)
        - name: grpc-server
          image: asia-northeast1-docker.pkg.dev/cloudsql-sv/postgres-prod/postgres-prod@sha256:854f970755d1f6abd918d0fde7b2f370f426fd9401b489b7c6f7b7ebd2302092
          env:
            - name: PORT
              value: "9090"
            - name: GCP_PROJECT_ID
              value: cloudsql-sv
            - name: GCP_REGION
              value: asia-northeast1
            - name: CLOUDSQL_INSTANCE_NAME
              value: postgres-prod
            - name: DB_NAME
              value: myapp
            - name: DB_USER
              value: 747065218280-compute@developer
          resources:
            limits:
              cpu: "1000m"
              memory: "512Mi"
          startupProbe:
            httpGet:
              path: /health
              port: 9090
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 10
